import speech_recognition as sr
import RPi.GPIO as GPIO
import time # time 라이브러리 추가

LED_PIN = 16
PWM_PIN_R = 17
PWM_PIN_L = 4

GPIO.setmode(GPIO.BCM)
GPIO.setup(LED_PIN, GPIO.OUT)
GPIO.setup(PWM_PIN_R, GPIO.OUT)
GPIO.setup(PWM_PIN_L, GPIO.OUT)

pwm_L = GPIO.PWM(PWM_PIN_L, 100)
pwm_R = GPIO.PWM(PWM_PIN_R, 100)

pwm_L.start(0)
pwm_R.start(0) 
GPIO.output(LED_PIN, GPIO.LOW) # LED 초기화

r = sr.Recognizer()
mic = sr.Microphone(device_index=1) # 마이크 인덱스 설정

try:
    while True:
        with mic as source:
            print("\n녹음 시작 (5초 동안 말씀하세요)...")
            audio = r.listen(source, timeout=5, phrase_time_limit=10)
        
        try:
            text = r.recognize_google(audio, language='ko-KR')
            print("인식 결과:", text)

            if text == "무척 더워":
                print("무척 더워 인식: 모터 90% 속도")
                pwm_L.ChangeDutyCycle(90)
            elif text == "더워": # elif로 변경하여 중복 실행 방지
                print("더워라고 인식: 모터 20% 속도")
                pwm_L.ChangeDutyCycle(20)
            elif text == "LED 꺼 줘":
                print("LED 꺼 줘 인식")
                GPIO.output(LED_PIN, GPIO.LOW)
            elif text == "LED 켜 줘":
                print("LED 켜 줘 인식")
                GPIO.output(LED_PIN, GPIO.HIGH)
            elif text == "모터 정지": # 명확한 정지 명령 추가
                print("모터 정지")
                pwm_L.ChangeDutyCycle(0)
                pwm_R.ChangeDutyCycle(0)
            else:
                print(f"등록되지 않은 명령: '{text}'")

        except sr.UnknownValueError:
            print("음성을 이해할 수 없습니다. 다시 시도하세요.")
        except sr.RequestError as e:
            print(f"API 요청 실패 (인터넷 연결 확인): {e}")
            time.sleep(2) # API 요청 실패 시 과부하 방지
            
except KeyboardInterrupt:
    print("\n프로그램 종료.")
    
finally:
    pwm_L.stop()
    pwm_R.stop()
    GPIO.cleanup()
